{% extends "base.html" %}
{% block title %}Checkout - Freshmo Brands 🛒💳✨{% endblock %}
{% block content %}
    <section class="products-section p-6 bg-white rounded-lg shadow-lg border border-[#00BFA5] my-8">
        <p class="mb-4"><a href="{{ url_for('menus') }}" class="btn-back text-[#00897B] hover:underline transition-colors duration-300">Back to Products ⬅️🛍️</a></p>
        <h1 class="text-4xl font-extrabold text-[#263238] mb-4 text-center">Checkout 🛒💳✨</h1>
        <div class="order-container grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="order-summary bg-[#E0F2F7] p-6 rounded-lg shadow-md border border-[#00BFA5]">
                <h2 class="text-2xl font-bold text-[#263238] mb-4">Order Summary 🌟📋</h2>
                <ul class="list-disc list-inside mb-4 text-lg text-[#455A64]">
                    {% for item in cart_items %}
                        <li>
                            {{ item.name }} (x{{ item.quantity }})
                            <br>
                            <span class="ml-4">Price (Excl. VAT): R{{ item.price_excl_vat_per_unit|floatformat(2) }} 💰</span>
                            <br>
                            <span class="ml-4">VAT (15%): R{{ item.vat_amount_per_unit|floatformat(2) }} 🧾</span>
                            <br>
                            <span class="ml-4 font-semibold">Total (Incl. VAT): R{{ item.price_incl_vat_per_unit|floatformat(2) }} ✨</span>
                            <br>
                            <span class="ml-4 font-bold">Line Total (Incl. VAT for quantity): R{{ item.total_incl_vat|floatformat(2) }} 💸</span>
                        </li>
                    {% endfor %}
                </ul>
                <hr class="my-4 border-[#00BFA5]">
                <p class="text-xl font-semibold text-[#263238]">Subtotal (Excl. VAT): R{{ subtotal_excl_vat|floatformat(2) }} 💸</p>
                <p class="text-xl font-semibold text-[#263238]">Total VAT (15%): R{{ total_vat_amount|floatformat(2) }} 🧾</p>
                {% if delivery_charge and delivery_charge > 0 %}
                    <p class="text-xl font-semibold text-[#263238]">Delivery Charge: R{{ delivery_charge|floatformat(2) }} 🚚</p>
                {% elif remembered_customer.delivery_type == 'Courier Guy' %}
                    <p class="text-xl font-semibold text-[#263238]">Delivery Charge: Subject to Quotation 📦</p>
                {% endif %}
                <p class="text-3xl font-extrabold text-[#00897B] mt-4"><strong>Grand Total (Incl. VAT): R{{ grand_total_incl_vat|floatformat(2) }} 💳</strong></p>
            </div>
            <form method="POST" action="{{ url_for('checkout') }}" class="checkout-form bg-[#E0F2F7] p-6 rounded-lg shadow-md border border-[#00BFA5]">
                <h2 class="text-2xl font-bold text-[#263238] mb-4">Your Details 👤</h2>
                <div class="mb-4">
                    <label for="name" class="block text-md font-semibold text-[#263238] mb-2">First Name * 👤</label>
                    <input type="text" id="name" name="name" value="{{ remembered_customer.name if remembered_customer else '' }}" required class="block w-full p-2 border border-gray-300 rounded-md focus:ring-[#00BFA5] focus:border-[#00BFA5]">
                </div>
                <div class="mb-4">
                    <label for="phone" class="block text-md font-semibold text-[#263238] mb-2">Phone Number * 📞</label>
                    <input type="tel" id="phone" name="phone" value="{{ remembered_customer.phone if remembered_customer else '' }}" required class="block w-full p-2 border border-gray-300 rounded-md focus:ring-[#00BFA5] focus:border-[#00BFA5]">
                </div>
                <div class="mb-4">
                    <label for="delivery_type" class="block text-md font-semibold text-[#263238] mb-2">Delivery Type * 🚛</label>
                    <select id="delivery_type" name="delivery_type" required class="block w-full p-2 border border-gray-300 rounded-md focus:ring-[#00BFA5] focus:border-[#00BFA5] bg-white text-gray-700">
                        <option value="Delivery" {% if remembered_customer.delivery_type == 'Delivery' %}selected{% endif %}>Local Delivery (R6/km) 🚚</option>
                        <option value="Collection" {% if remembered_customer.delivery_type == 'Collection' %}selected{% endif %}>Collection 🏬</option>
                        <option value="PEP PAXI" {% if remembered_customer.delivery_type == 'PEP PAXI' %}selected{% endif %}>PEP PAXI (R60.00 incl. VAT) 🏪</option>
                        <option value="Aramex" {% if remembered_customer.delivery_type == 'Aramex' %}selected{% endif %}>Aramex (R120.00 incl. VAT) ✈️</option>
                        <option value="Courier Guy" {% if remembered_customer.delivery_type == 'Courier Guy' %}selected{% endif %}>Courier Guy (Subject to Quotation) 📦</option>
                    </select>
                </div>
                <div id="address_field_container" class="mb-4" style="display: {% if remembered_customer.delivery_type == 'Delivery' %}block{% else %}none{% endif %};">
                    <label for="address" class="block text-md font-semibold text-[#263238] mb-2">Delivery Address * 🏠</label>
                    <input type="text" id="address" name="address" value="{{ remembered_customer.address if remembered_customer else '' }}" {% if remembered_customer.delivery_type == 'Delivery' %}required{% endif %} class="block w-full p-2 border border-gray-300 rounded-md focus:ring-[#00BFA5] focus:border-[#00BFA5]">
                </div>
                <div id="special_note_container" class="mb-4" style="display: {% if remembered_customer.delivery_type == 'Courier Guy' %}block{% else %}none{% endif %};">
                    <label for="special_note" class="block text-md font-semibold text-[#263238] mb-2">Special Note (for Courier Guy quotation) * 📝</label>
                    <textarea id="special_note" name="special_note" rows="3" class="block w-full p-2 border border-gray-300 rounded-md focus:ring-[#00BFA5] focus:border-[#00BFA5]" {% if remembered_customer.delivery_type == 'Courier Guy' %}required{% endif %} placeholder="Please provide details for the Courier Guy quotation (e.g., specific location, preferred delivery time, etc.)"></textarea>
                </div>
                <div class="mb-6">
                    <label for="payment_method" class="block text-md font-semibold text-[#263238] mb-2">Payment Method * 💳</label>
                    <select id="payment_method" name="payment_method" required class="block w-full p-2 border border-gray-300 rounded-md focus:ring-[#00BFA5] focus:border-[#00BFA5] bg-white text-gray-700">
                        <option value="Cash on Collection">Cash on Collection 💵</option>
                        <option value="Cash on Delivery">Cash on Delivery 🚚</option>
                        <option value="EFT">EFT 🏦</option>
                        <option value="Instant Cash">Instant Cash ⚡</option>
                        <option value="In-App (coming soon)" disabled>In-App (coming soon) 📱</option>
                    </select>
                </div>
                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="remember" name="remember" {% if remembered_customer %}checked{% endif %} class="mr-2 h-4 w-4 text-[#00BFA5] border-gray-300 rounded focus:ring-[#00BFA5]">
                    <label for="remember" class="text-md font-semibold text-[#263238]">Remember my details for next time ✅</label>
                </div>
                <button type="submit" class="btn bg-[#00BFA5] text-white px-6 py-3 rounded-full text-lg font-semibold shadow-md hover:bg-[#00897B] transition-colors duration-300 w-full">Place Order 🚀🎉</button>
            </form>
        </div>
        <p class="mt-8 text-center">
            <a href="{{ url_for('menus') }}" class="btn-back text-[#00897B] hover:underline transition-colors duration-300">Back to Products ⬅️🛍️</a>
        </p>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deliveryTypeSelect = document.getElementById('delivery_type');
            const addressFieldContainer = document.getElementById('address_field_container');
            const addressInput = document.getElementById('address');
            const specialNoteContainer = document.getElementById('special_note_container');
            const specialNoteTextarea = document.getElementById('special_note');

            function toggleDeliveryFields() {
                const selectedDeliveryType = deliveryTypeSelect.value;

                // Toggle Address Field visibility and required attribute
                if (selectedDeliveryType === 'Delivery') {
                    addressFieldContainer.style.display = 'block';
                    addressInput.setAttribute('required', 'required');
                } else {
                    addressFieldContainer.style.display = 'none';
                    addressInput.removeAttribute('required');
                    addressInput.value = ''; // Clear address if not delivery
                }

                // Toggle Special Note field for Courier Guy
                if (selectedDeliveryType === 'Courier Guy') {
                    specialNoteContainer.style.display = 'block';
                    specialNoteTextarea.setAttribute('required', 'required');
                } else {
                    specialNoteContainer.style.display = 'none';
                    specialNoteTextarea.removeAttribute('required');
                    specialNoteTextarea.value = ''; // Clear special note if not Courier Guy
                }
            }

            deliveryTypeSelect.addEventListener('change', toggleDeliveryFields);
            // Call on page load to set initial state based on remembered customer or default
            toggleDeliveryFields();
        });
    </script>
{% endblock %}
